import { Component, Input, Output, EventEmitter, ViewChild, ViewChildren, QueryList, ChangeDetectionStrategy } from '@angular/core';
import { from, distinctUntilChanged, fromEvent, mergeMap, startWith, EMPTY, Observable, Subject, animationFrameScheduler } from 'rxjs';
import { tap, debounceTime, filter, takeUntil, switchMap } from 'rxjs/operators';
import { SlidingDirection } from '../models/constants';
import { HorizontalAdapter, VerticalAdapter } from './adapters';
import { resizeObservable } from '../utils/resize-observer';
import { GalleryItemComponent } from './gallery-item.component';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/platform";
import * as i2 from "../smooth-scroll";
import * as i3 from "../services/gallery.service";
import * as i4 from "@angular/common";
import * as i5 from "./gallery-item.component";
export class GallerySliderComponent {
    constructor(_el, _cd, _zone, _platform, _smoothScroll, _gallery) {
        this._el = _el;
        this._cd = _cd;
        this._zone = _zone;
        this._platform = _platform;
        this._smoothScroll = _smoothScroll;
        this._gallery = _gallery;
        this.scrollHandler$ = new Subject();
        this.visibleElements = new Map();
        this._destroyed$ = new Subject();
        /** Stream that emits when item is clicked */
        this.itemClick = new EventEmitter();
        /** Stream that emits when an error occurs */
        this.error = new EventEmitter();
        this.items = new QueryList();
        this.scrollHandler$.pipe(debounceTime(0, animationFrameScheduler), switchMap(({ value, behavior }) => {
            this._gallery.debugConsole('[Gallery scrollHandler$] ', this.slider.style.scrollSnapType);
            this.slider.style.scrollSnapType = 'unset';
            const el = this.items.get(value)?.element;
            this._gallery.debugConsole('ðŸ¤¯ [Gallery scrollHandler$] scrollSnapType = unset, scrollTo element', !!el);
            if (el) {
                this.slider.classList.add('g-scrolling');
                const pos = this.adapter.getScrollToValue(el, behavior || this.config.scrollBehavior);
                const index = +this.items.get(value)?.element.getAttribute('galleryIndex');
                this._gallery.debugConsole(`ðŸš€ [Gallery scrollHandler$] Scroll start ===> index: ${index}, position:`, pos);
                this._gallery.debugConsole(`ðŸš€ [Gallery scrollHandler$] slider scrollable`, this.adapter.scrollValue);
                return from(this._smoothScroll.scrollTo(this.slider, pos)).pipe(tap(() => {
                    // Reset viewport properties on scroll end
                    this._isPanning = false;
                    this.slider.classList.remove('g-scrolling');
                    this.slider.style.scrollSnapType = this.adapter.scrollSnapType;
                    this._gallery.debugConsole('âœ… [Gallery scrollHandler$] Scroll end');
                }));
            }
            this._gallery.debugConsole('ðŸ˜¡ [Gallery scrollHandler$] Scroll element was not found!');
            return EMPTY;
        }), takeUntil(this._destroyed$)).subscribe();
    }
    get slider() {
        return this.sliderEl.nativeElement;
    }
    ngOnChanges(changes) {
        if (changes.config) {
            if (changes.config.currentValue?.slidingDirection !== changes.config.previousValue?.slidingDirection) {
                switch (this.config.slidingDirection) {
                    case SlidingDirection.Horizontal:
                        this.adapter = new HorizontalAdapter(this.slider, this.config);
                        break;
                    case SlidingDirection.Vertical:
                        this.adapter = new VerticalAdapter(this.slider, this.config);
                        break;
                }
                if (!changes.config.firstChange) {
                    requestAnimationFrame(() => {
                        // Keep the correct sliding position when direction changes
                        this.scrollToIndex(this.state.currIndex, 'auto');
                    });
                }
                // Reactivate gestures
                this.enableDisableGestures();
            }
            if (!changes.config.firstChange) {
                if (changes.config.currentValue?.mouseSlidingDisabled !== changes.config.previousValue?.mouseSlidingDisabled) {
                    this.enableDisableGestures();
                }
            }
        }
        // Scroll to current index
        if (changes.state && changes.state.currentValue?.currIndex !== changes.state.previousValue?.currIndex) {
            requestAnimationFrame(() => {
                this.scrollToIndex(this.state.currIndex, changes.state.firstChange ? 'auto' : this.state.behavior);
            });
        }
    }
    ngOnInit() {
        this._zone.runOutsideAngular(() => {
            // We need to set the visibleElements in the viewport using intersection observer
            this.createIntersectionObserver(this.slider).pipe(tap((entry) => {
                entry.target.classList.toggle('g-item-visible', entry.isIntersecting);
                if (entry.isIntersecting) {
                    this.visibleElements.set(entry.target, entry);
                }
                else {
                    this.visibleElements.delete(entry.target);
                }
            }), takeUntil(this._destroyed$)).subscribe();
            // Subscribe to slider scroll event
            fromEvent(this.slider, 'scroll', { passive: true }).pipe(debounceTime(50), filter(() => !this._isPanning), tap(() => this.onViewportScroll()), takeUntil(this._destroyed$)).subscribe();
            // Detect if the size of the slider has changed detecting current index on scroll
            if (this._platform.isBrowser) {
                resizeObservable(this._el.nativeElement).pipe(debounceTime(this.config.resizeDebounceTime), tap(([entry]) => this.onHostResize(entry)), takeUntil(this._destroyed$)).subscribe();
            }
        });
    }
    ngAfterViewInit() {
        this.items.notifyOnChanges();
        this.items.changes.pipe(startWith(null), tap(() => {
            // Disconnect all and reconnect later
            this.visibleElements.forEach((item) => {
                this.intersectionObserver.unobserve(item.target);
            });
            // Connect with the new items
            this.items.toArray().map((item) => {
                this.intersectionObserver.observe(item.element);
            });
        }), takeUntil(this._destroyed$)).subscribe();
    }
    ngAfterViewChecked() {
        if (this.config.itemAutosize) {
            this.slider.style.setProperty('--slider-centralize-start-size', this.adapter.getCentralizerStartSize() + 'px');
            this.slider.style.setProperty('--slider-centralize-end-size', this.adapter.getCentralizerEndSize() + 'px');
        }
    }
    ngOnDestroy() {
        this._destroyed$.next();
        this._destroyed$.complete();
        this.deactivateGestures();
    }
    trackByFn(index, item) {
        return item.type;
    }
    onHostResize(entry) {
        const width = Math.ceil(entry.contentRect.width);
        const height = Math.ceil(entry.contentRect.height);
        this.slider.style.width = `${width}px`;
        this.slider.style.height = `${height}px`;
        this.scrollToIndex(this.state.currIndex, 'auto');
        // Detect changes on gallery-item components to re-calculate item size
        this._cd.detectChanges();
        this._gallery.debugConsole('ðŸ¦ [Gallery OnHostResize]: set viewport width to absolute number');
    }
    onViewportScroll() {
        // Check if scrolled item is great enough to navigate
        const currElement = this.items.get(this.state.currIndex)?.element;
        const elementAtCenter = this.getElementFromViewportCenter();
        if (elementAtCenter) {
            // Check if the gallery-item element is not the active element
            if (elementAtCenter !== currElement) {
                this.tryScrollToElement(elementAtCenter);
            }
        }
        else {
            this._gallery.debugConsole('â‰ [Gallery onViewportScroll]: No center element was found');
            this.visibleElements.forEach((entry) => {
                this.tryScrollToElement(entry.target);
            });
        }
    }
    tryScrollToElement(elementAtCenter) {
        const allowedMargin = 10;
        const offsetDiff = (this.adapter.clientSize - this.adapter.getClientSize(elementAtCenter)) / 2;
        const rangeStart = this.adapter.scrollValue + offsetDiff;
        const rangeEnd = this.adapter.scrollValue + this.adapter.clientSize - offsetDiff;
        const elStart = this.adapter.getOffsetSize(elementAtCenter);
        const elEnd = elStart + this.adapter.getClientSize(elementAtCenter);
        const isStart = rangeStart + allowedMargin >= elStart && rangeStart - allowedMargin <= elStart;
        const isEnd = rangeEnd + allowedMargin >= elEnd && rangeEnd - allowedMargin <= elEnd;
        // Reset position
        this.slider.style.scrollSnapType = this.adapter.scrollSnapType;
        // Check if element is within the detection range
        if (isStart && isEnd) {
            // If element is within the range set it as the active gallery item
            this._gallery.debugConsole('ðŸ„ [Gallery onViewportScroll]: Set active gallery item');
            const index = +elementAtCenter.getAttribute('galleryIndex');
            this._zone.run(() => this._gallery.ref(this.galleryId).set(index, 'smooth'));
        }
    }
    scrollToIndex(value, behavior, onEnd) {
        this.scrollHandler$.next({ value, behavior, onEnd });
    }
    enableDisableGestures() {
        // Enable/Disable mouse sliding on desktop browser only
        if (!this._platform.IOS && !this._platform.ANDROID) {
            if (!this.config.mouseSlidingDisabled) {
                this.activateGestures();
            }
            else {
                this.deactivateGestures();
            }
        }
    }
    activateGestures() {
        if (typeof Hammer !== 'undefined') {
            // Destroy hammer if a previous instance was created
            this.deactivateGestures();
            const direction = this.adapter.panDirection;
            // Activate gestures
            this._zone.runOutsideAngular(() => {
                this._hammer = new Hammer(this._el.nativeElement, { inputClass: Hammer.MouseInput });
                this._hammer.get('pan').set({ direction });
                let panOffset;
                // Set panOffset for sliding on pan start event
                this._hammer.on('panstart', () => {
                    this._smoothScroll.dismissOngoingScroll(this.slider);
                    panOffset = this.adapter.scrollValue;
                    // Disable scroll-snap-type functionality
                    this.slider.style.scrollSnapType = 'unset';
                    this.slider.classList.add('g-sliding');
                    this._isPanning = true;
                });
                this._hammer.on('panmove', (e) => this.slider.scrollTo(this.adapter.getPanValue(panOffset, e, 'auto')));
                this._hammer.on('panend', (e) => this.onPanEnd(e));
            });
        }
    }
    deactivateGestures() {
        this._hammer?.destroy();
    }
    onPanEnd(e) {
        this._gallery.debugConsole('ðŸ–±ï¸ [Gallery]: onPanEnd', e);
        this.slider.classList.remove('g-sliding');
        const delta = this.adapter.getPanDelta(e);
        const velocity = this.adapter.getPanVelocity(e);
        const galleryRef = this._gallery.ref(this.galleryId);
        this._zone.run(() => {
            // Check if scrolled item is great enough to navigate
            const currElement = this.items.get(this.state.currIndex)?.element;
            // Find the gallery item element in the center elements
            const elementAtCenter = this.getElementFromViewportCenter();
            // Check if center item can be taken from element using
            if (elementAtCenter && elementAtCenter !== currElement) {
                const index = +elementAtCenter.getAttribute('galleryIndex');
                this.scrollToIndex(index, 'smooth');
                return;
            }
            // Check if delta is great enough to navigate
            if (Math.abs(delta) > (currElement.clientWidth || this.adapter.clientSize) / 2) {
                return delta > 0 ? galleryRef.prev('smooth', false) : galleryRef.next('smooth', false);
            }
            // Check if velocity is great enough to navigate
            if (Math.abs(velocity) > 0.3) {
                return velocity > 0 ? galleryRef.prev('smooth', false) : galleryRef.next('smooth', false);
            }
            // Reset position to the current index
            this.scrollToIndex(this.state.currIndex, 'smooth');
        });
    }
    getElementFromViewportCenter() {
        // Get slider position relative to the document
        const sliderRect = this.slider.getBoundingClientRect();
        // Try look for the center item using `elementsFromPoint` function
        const centerElements = document.elementsFromPoint(sliderRect.x + (sliderRect.width / 2), sliderRect.y + (sliderRect.height / 2));
        // Find the gallery item element in the center elements
        const element = centerElements.find((element) => element.localName === 'gallery-item' && element.getAttribute('galleryId') === this.galleryId);
        this._gallery.debugConsole('ðŸªŸ [Gallery]: getElementFromViewportCenter', element);
        return element;
    }
    createIntersectionObserver(slider) {
        return new Observable((observer) => {
            this.intersectionObserver = new IntersectionObserver((entries) => observer.next(entries), { root: slider });
            return () => this.intersectionObserver.disconnect();
        }).pipe(mergeMap((entries) => entries), distinctUntilChanged());
    }
}
GallerySliderComponent.Éµfac = i0.ÉµÉµngDeclareFactory({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: GallerySliderComponent, deps: [{ token: i0.ElementRef }, { token: i0.ChangeDetectorRef }, { token: i0.NgZone }, { token: i1.Platform }, { token: i2.SmoothScrollManager }, { token: i3.Gallery }], target: i0.ÉµÉµFactoryTarget.Component });
GallerySliderComponent.Éµcmp = i0.ÉµÉµngDeclareComponent({ minVersion: "14.0.0", version: "15.1.0", type: GallerySliderComponent, selector: "gallery-slider", inputs: { galleryId: "galleryId", state: "state", config: "config" }, outputs: { itemClick: "itemClick", error: "error" }, viewQueries: [{ propertyName: "sliderEl", first: true, predicate: ["slider"], descendants: true, static: true }, { propertyName: "items", predicate: GalleryItemComponent, descendants: true }], usesOnChanges: true, ngImport: i0, template: `
    <div #slider
         class="g-slider"
         [attr.centralised]="config.itemAutosize">
      <div class="g-slider-content">
        <gallery-item *ngFor="let item of state.items; trackBy: trackByFn; index as i"
                      [attr.galleryId]="galleryId"
                      [type]="item.type"
                      [config]="config"
                      [data]="item.data"
                      [currIndex]="state.currIndex"
                      [index]="i"
                      (click)="itemClick.emit(i)"
                      (error)="error.emit({ itemIndex: i, error: $event })">
        </gallery-item>
      </div>
    </div>
    <ng-content></ng-content>
  `, isInline: true, dependencies: [{ kind: "directive", type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "component", type: i5.GalleryItemComponent, selector: "gallery-item", inputs: ["config", "index", "currIndex", "type", "data"], outputs: ["error"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ÉµÉµngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.0", ngImport: i0, type: GallerySliderComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'gallery-slider',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    template: `
    <div #slider
         class="g-slider"
         [attr.centralised]="config.itemAutosize">
      <div class="g-slider-content">
        <gallery-item *ngFor="let item of state.items; trackBy: trackByFn; index as i"
                      [attr.galleryId]="galleryId"
                      [type]="item.type"
                      [config]="config"
                      [data]="item.data"
                      [currIndex]="state.currIndex"
                      [index]="i"
                      (click)="itemClick.emit(i)"
                      (error)="error.emit({ itemIndex: i, error: $event })">
        </gallery-item>
      </div>
    </div>
    <ng-content></ng-content>
  `
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.ChangeDetectorRef }, { type: i0.NgZone }, { type: i1.Platform }, { type: i2.SmoothScrollManager }, { type: i3.Gallery }]; }, propDecorators: { galleryId: [{
                type: Input
            }], state: [{
                type: Input
            }], config: [{
                type: Input
            }], itemClick: [{
                type: Output
            }], error: [{
                type: Output
            }], sliderEl: [{
                type: ViewChild,
                args: ['slider', { static: true }]
            }], items: [{
                type: ViewChildren,
                args: [GalleryItemComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FsbGVyeS1zbGlkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctZ2FsbGVyeS9zcmMvbGliL2NvbXBvbmVudHMvZ2FsbGVyeS1zbGlkZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBTVosU0FBUyxFQUNULFlBQVksRUFJWixTQUFTLEVBRVQsdUJBQXVCLEVBQ3hCLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFDTCxJQUFJLEVBQ0osb0JBQW9CLEVBQ3BCLFNBQVMsRUFDVCxRQUFRLEVBQ1IsU0FBUyxFQUNULEtBQUssRUFDTCxVQUFVLEVBQ1YsT0FBTyxFQUVQLHVCQUF1QixFQUN4QixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJakYsT0FBTyxFQUFFLGdCQUFnQixFQUFrQixNQUFNLHFCQUFxQixDQUFDO0FBQ3ZFLE9BQU8sRUFBaUIsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRS9FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7Ozs7O0FBaUNoRSxNQUFNLE9BQU8sc0JBQXNCO0lBeUNqQyxZQUFvQixHQUFlLEVBQ2YsR0FBc0IsRUFDdEIsS0FBYSxFQUNiLFNBQW1CLEVBQ25CLGFBQWtDLEVBQ2xDLFFBQWlCO1FBTGpCLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUN0QixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQ2IsY0FBUyxHQUFULFNBQVMs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QUFDLENBQUMsUUFBaUQsRUFBRSxFQUFFO1lBQzFFLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLG9CQUFvQixDQUNsRCxDQUFDLE9BQW9DLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQ2hFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUNqQixDQUFDO1lBQ0YsT0FBTyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNMLFFBQVEsQ0FBQyxDQUFDLE9BQW9DLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUMzRCxvQkFBb0IsRUFBRSxDQUN2QixDQUFDO0lBQ0osQ0FBQzs7bUhBbFdVLHNCQUFzQjt1R0FBdEIsc0JBQXNCLDhTQW1DbkIsb0JBQW9CLHFFQXZEeEI7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCVDsyRkFFVSxzQkFBc0I7a0JBdkJsQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO29CQUMvQyxRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCVDtpQkFDRjtxT0FvQlUsU0FBUztzQkFBakIsS0FBSztnQkFHRyxLQUFLO3NCQUFiLEtBQUs7Z0JBR0csTUFBTTtzQkFBZCxLQUFLO2dCQUdJLFNBQVM7c0JBQWxCLE1BQU07Z0JBR0csS0FBSztzQkFBZCxNQUFNO2dCQUVnQyxRQUFRO3NCQUE5QyxTQUFTO3VCQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7Z0JBRUQsS0FBSztzQkFBeEMsWUFBWTt1QkFBQyxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQWZ0ZXJWaWV3Q2hlY2tlZCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE9uQ2hhbmdlcyxcbiAgVmlld0NoaWxkLFxuICBWaWV3Q2hpbGRyZW4sXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE5nWm9uZSxcbiAgRWxlbWVudFJlZixcbiAgUXVlcnlMaXN0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3lcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XG5pbXBvcnQge1xuICBmcm9tLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgZnJvbUV2ZW50LFxuICBtZXJnZU1hcCxcbiAgc3RhcnRXaXRoLFxuICBFTVBUWSxcbiAgT2JzZXJ2YWJsZSxcbiAgU3ViamVjdCxcbiAgU3Vic2NyaWJlcixcbiAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXJcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAsIGRlYm91bmNlVGltZSwgZmlsdGVyLCB0YWtlVW50aWwsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEdhbGxlcnkgfSBmcm9tICcuLi9zZXJ2aWNlcy9nYWxsZXJ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgR2FsbGVyeVN0YXRlLCBHYWxsZXJ5RXJyb3IgfSBmcm9tICcuLi9tb2RlbHMvZ2FsbGVyeS5tb2RlbCc7XG5pbXBvcnQgeyBHYWxsZXJ5Q29uZmlnIH0gZnJvbSAnLi4vbW9kZWxzL2NvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBTbGlkaW5nRGlyZWN0aW9uLCBUaHVtYm5haWxzVmlldyB9IGZyb20gJy4uL21vZGVscy9jb25zdGFudHMnO1xuaW1wb3J0IHsgU2xpZGVyQWRhcHRlciwgSG9yaXpvbnRhbEFkYXB0ZXIsIFZlcnRpY2FsQWRhcHRlciB9IGZyb20gJy4vYWRhcHRlcnMnO1xuaW1wb3J0IHsgU21vb3RoU2Nyb2xsTWFuYWdlciB9IGZyb20gJy4uL3Ntb290aC1zY3JvbGwnO1xuaW1wb3J0IHsgcmVzaXplT2JzZXJ2YWJsZSB9IGZyb20gJy4uL3V0aWxzL3Jlc2l6ZS1vYnNlcnZlcic7XG5pbXBvcnQgeyBHYWxsZXJ5SXRlbUNvbXBvbmVudCB9IGZyb20gJy4vZ2FsbGVyeS1pdGVtLmNvbXBvbmVudCc7XG5cbmludGVyZmFjZSBTY3JvbGxPYnNlcnZlciB7XG4gIHZhbHVlOiBudW1iZXI7XG4gIGJlaGF2aW9yOiBTY3JvbGxCZWhhdmlvcjtcbiAgb25FbmQ6IEZ1bmN0aW9uO1xufVxuXG5kZWNsYXJlIGNvbnN0IEhhbW1lcjogYW55O1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdnYWxsZXJ5LXNsaWRlcicsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxkaXYgI3NsaWRlclxuICAgICAgICAgY2xhc3M9XCJnLXNsaWRlclwiXG4gICAgICAgICBbYXR0ci5jZW50cmFsaXNlZF09XCJjb25maWcuaXRlbUF1dG9zaXplXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiZy1zbGlkZXItY29udGVudFwiPlxuICAgICAgICA8Z2FsbGVyeS1pdGVtICpuZ0Zvcj1cImxldCBpdGVtIG9mIHN0YXRlLml0ZW1zOyB0cmFja0J5OiB0cmFja0J5Rm47IGluZGV4IGFzIGlcIlxuICAgICAgICAgICAgICAgICAgICAgIFthdHRyLmdhbGxlcnlJZF09XCJnYWxsZXJ5SWRcIlxuICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXT1cIml0ZW0udHlwZVwiXG4gICAgICAgICAgICAgICAgICAgICAgW2NvbmZpZ109XCJjb25maWdcIlxuICAgICAgICAgICAgICAgICAgICAgIFtkYXRhXT1cIml0ZW0uZGF0YVwiXG4gICAgICAgICAgICAgICAgICAgICAgW2N1cnJJbmRleF09XCJzdGF0ZS5jdXJySW5kZXhcIlxuICAgICAgICAgICAgICAgICAgICAgIFtpbmRleF09XCJpXCJcbiAgICAgICAgICAgICAgICAgICAgICAoY2xpY2spPVwiaXRlbUNsaWNrLmVtaXQoaSlcIlxuICAgICAgICAgICAgICAgICAgICAgIChlcnJvcik9XCJlcnJvci5lbWl0KHsgaXRlbUluZGV4OiBpLCBlcnJvcjogJGV2ZW50IH0pXCI+XG4gICAgICAgIDwvZ2FsbGVyeS1pdGVtPlxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PlxuICBgXG59KVxuZXhwb3J0IGNsYXNzIEdhbGxlcnlTbGlkZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgQWZ0ZXJWaWV3SW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCwgT25EZXN0cm95IHtcblxuICByZWFkb25seSBzY3JvbGxIYW5kbGVyJDogU3ViamVjdDxTY3JvbGxPYnNlcnZlcj4gPSBuZXcgU3ViamVjdDxTY3JvbGxPYnNlcnZlcj4oKTtcblxuICAvKiogSGFtbWVySlMgaW5zdGFuY2UgKi9cbiAgcHJpdmF0ZSBfaGFtbWVyOiBhbnk7XG5cbiAgcHJpdmF0ZSBpbnRlcnNlY3Rpb25PYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXI7XG5cbiAgcHJpdmF0ZSB2aXNpYmxlRWxlbWVudHM6IE1hcDxFbGVtZW50LCBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5PiA9IG5ldyBNYXA8RWxlbWVudCwgSW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeT4oKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBwcml2YXRlIF9pc1Bhbm5pbmc6IGJvb2xlYW47XG5cbiAgLyoqIFNsaWRlciBhZGFwdGVyICovXG4gIGFkYXB0ZXI6IFNsaWRlckFkYXB0ZXI7XG5cbiAgLyoqIEdhbGxlcnkgSUQgKi9cbiAgQElucHV0KCkgZ2FsbGVyeUlkOiBzdHJpbmc7XG5cbiAgLyoqIEdhbGxlcnkgc3RhdGUgKi9cbiAgQElucHV0KCkgc3RhdGU6IEdhbGxlcnlTdGF0ZTtcblxuICAvKiogR2FsbGVyeSBjb25maWcgKi9cbiAgQElucHV0KCkgY29uZmlnOiBHYWxsZXJ5Q29uZmlnO1xuXG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGl0ZW0gaXMgY2xpY2tlZCAqL1xuICBAT3V0cHV0KCkgaXRlbUNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG5cbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gYW4gZXJyb3Igb2NjdXJzICovXG4gIEBPdXRwdXQoKSBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXI8R2FsbGVyeUVycm9yPigpO1xuXG4gIEBWaWV3Q2hpbGQoJ3NsaWRlcicsIHsgc3RhdGljOiB0cnVlIH0pIHNsaWRlckVsOiBFbGVtZW50UmVmO1xuXG4gIEBWaWV3Q2hpbGRyZW4oR2FsbGVyeUl0ZW1Db21wb25lbnQpIGl0ZW1zID0gbmV3IFF1ZXJ5TGlzdDxHYWxsZXJ5SXRlbUNvbXBvbmVudD4oKTtcblxuICBnZXQgc2xpZGVyKCk6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5zbGlkZXJFbC5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWw6IEVsZW1lbnRSZWYsXG4gICAgICAgICAgICAgIHByaXZhdGUgX2NkOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfem9uZTogTmdab25lLFxuICAgICAgICAgICAgICBwcml2YXRlIF9wbGF0Zm9ybTogUGxhdGZvcm0sXG4gICAgICAgICAgICAgIHByaXZhdGUgX3Ntb290aFNjcm9sbDogU21vb3RoU2Nyb2xsTWFuYWdlcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfZ2FsbGVyeTogR2FsbGVyeSkge1xuXG4gICAgdGhpcy5zY3JvbGxIYW5kbGVyJC5waXBlKFxuICAgICAgZGVib3VuY2VUaW1lKDAsIGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyKSxcbiAgICAgIHN3aXRjaE1hcCgoeyB2YWx1ZSwgYmVoYXZpb3IgfTogU2Nyb2xsT2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoJ1tHYWxsZXJ5IHNjcm9sbEhhbmRsZXIkXSAnLCB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSk7XG4gICAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNjcm9sbFNuYXBUeXBlID0gJ3Vuc2V0JztcbiAgICAgICAgY29uc3QgZWw6IEhUTUxFbGVtZW50ID0gdGhpcy5pdGVtcy5nZXQodmFsdWUpPy5lbGVtZW50O1xuXG4gICAgICAgIHRoaXMuX2dhbGxlcnkuZGVidWdDb25zb2xlKCfwn6SvIFtHYWxsZXJ5IHNjcm9sbEhhbmRsZXIkXSBzY3JvbGxTbmFwVHlwZSA9IHVuc2V0LCBzY3JvbGxUbyBlbGVtZW50JywgISFlbCk7XG4gICAgICAgIGlmIChlbCkge1xuICAgICAgICAgIHRoaXMuc2xpZGVyLmNsYXNzTGlzdC5hZGQoJ2ctc2Nyb2xsaW5nJyk7XG4gICAgICAgICAgY29uc3QgcG9zID0gdGhpcy5hZGFwdGVyLmdldFNjcm9sbFRvVmFsdWUoZWwsIGJlaGF2aW9yIHx8IHRoaXMuY29uZmlnLnNjcm9sbEJlaGF2aW9yKTtcbiAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gK3RoaXMuaXRlbXMuZ2V0KHZhbHVlKT8uZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2dhbGxlcnlJbmRleCcpO1xuICAgICAgICAgIHRoaXMuX2dhbGxlcnkuZGVidWdDb25zb2xlKGDwn5qAIFtHYWxsZXJ5IHNjcm9sbEhhbmRsZXIkXSBTY3JvbGwgc3RhcnQgPT09PiBpbmRleDogJHsgaW5kZXggfSwgcG9zaXRpb246YCwgcG9zKTtcbiAgICAgICAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZShg8J+agCBbR2FsbGVyeSBzY3JvbGxIYW5kbGVyJF0gc2xpZGVyIHNjcm9sbGFibGVgLCB0aGlzLmFkYXB0ZXIuc2Nyb2xsVmFsdWUpO1xuXG4gICAgICAgICAgcmV0dXJuIGZyb20odGhpcy5fc21vb3RoU2Nyb2xsLnNjcm9sbFRvKHRoaXMuc2xpZGVyLCBwb3MpKS5waXBlKFxuICAgICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgICAgLy8gUmVzZXQgdmlld3BvcnQgcHJvcGVydGllcyBvbiBzY3JvbGwgZW5kXG4gICAgICAgICAgICAgIHRoaXMuX2lzUGFubmluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICB0aGlzLnNsaWRlci5jbGFzc0xpc3QucmVtb3ZlKCdnLXNjcm9sbGluZycpO1xuICAgICAgICAgICAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9IHRoaXMuYWRhcHRlci5zY3JvbGxTbmFwVHlwZTtcbiAgICAgICAgICAgICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoJ+KchSBbR2FsbGVyeSBzY3JvbGxIYW5kbGVyJF0gU2Nyb2xsIGVuZCcpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2dhbGxlcnkuZGVidWdDb25zb2xlKCfwn5ihIFtHYWxsZXJ5IHNjcm9sbEhhbmRsZXIkXSBTY3JvbGwgZWxlbWVudCB3YXMgbm90IGZvdW5kIScpO1xuICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICB9KSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQkKVxuICAgICkuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuY29uZmlnKSB7XG4gICAgICBpZiAoY2hhbmdlcy5jb25maWcuY3VycmVudFZhbHVlPy5zbGlkaW5nRGlyZWN0aW9uICE9PSBjaGFuZ2VzLmNvbmZpZy5wcmV2aW91c1ZhbHVlPy5zbGlkaW5nRGlyZWN0aW9uKSB7XG4gICAgICAgIHN3aXRjaCAodGhpcy5jb25maWcuc2xpZGluZ0RpcmVjdGlvbikge1xuICAgICAgICAgIGNhc2UgU2xpZGluZ0RpcmVjdGlvbi5Ib3Jpem9udGFsOlxuICAgICAgICAgICAgdGhpcy5hZGFwdGVyID0gbmV3IEhvcml6b250YWxBZGFwdGVyKHRoaXMuc2xpZGVyLCB0aGlzLmNvbmZpZyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFNsaWRpbmdEaXJlY3Rpb24uVmVydGljYWw6XG4gICAgICAgICAgICB0aGlzLmFkYXB0ZXIgPSBuZXcgVmVydGljYWxBZGFwdGVyKHRoaXMuc2xpZGVyLCB0aGlzLmNvbmZpZyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2hhbmdlcy5jb25maWcuZmlyc3RDaGFuZ2UpIHtcbiAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgLy8gS2VlcCB0aGUgY29ycmVjdCBzbGlkaW5nIHBvc2l0aW9uIHdoZW4gZGlyZWN0aW9uIGNoYW5nZXNcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLnN0YXRlLmN1cnJJbmRleCwgJ2F1dG8nKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlYWN0aXZhdGUgZ2VzdHVyZXNcbiAgICAgICAgdGhpcy5lbmFibGVEaXNhYmxlR2VzdHVyZXMoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFjaGFuZ2VzLmNvbmZpZy5maXJzdENoYW5nZSkge1xuICAgICAgICBpZiAoY2hhbmdlcy5jb25maWcuY3VycmVudFZhbHVlPy5tb3VzZVNsaWRpbmdEaXNhYmxlZCAhPT0gY2hhbmdlcy5jb25maWcucHJldmlvdXNWYWx1ZT8ubW91c2VTbGlkaW5nRGlzYWJsZWQpIHtcbiAgICAgICAgICB0aGlzLmVuYWJsZURpc2FibGVHZXN0dXJlcygpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2Nyb2xsIHRvIGN1cnJlbnQgaW5kZXhcbiAgICBpZiAoY2hhbmdlcy5zdGF0ZSAmJiBjaGFuZ2VzLnN0YXRlLmN1cnJlbnRWYWx1ZT8uY3VyckluZGV4ICE9PSBjaGFuZ2VzLnN0YXRlLnByZXZpb3VzVmFsdWU/LmN1cnJJbmRleCkge1xuICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KHRoaXMuc3RhdGUuY3VyckluZGV4LCBjaGFuZ2VzLnN0YXRlLmZpcnN0Q2hhbmdlID8gJ2F1dG8nIDogdGhpcy5zdGF0ZS5iZWhhdmlvcik7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLl96b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcblxuICAgICAgLy8gV2UgbmVlZCB0byBzZXQgdGhlIHZpc2libGVFbGVtZW50cyBpbiB0aGUgdmlld3BvcnQgdXNpbmcgaW50ZXJzZWN0aW9uIG9ic2VydmVyXG4gICAgICB0aGlzLmNyZWF0ZUludGVyc2VjdGlvbk9ic2VydmVyKHRoaXMuc2xpZGVyKS5waXBlKFxuICAgICAgICB0YXAoKGVudHJ5OiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5KSA9PiB7XG4gICAgICAgICAgZW50cnkudGFyZ2V0LmNsYXNzTGlzdC50b2dnbGUoJ2ctaXRlbS12aXNpYmxlJywgZW50cnkuaXNJbnRlcnNlY3RpbmcpO1xuICAgICAgICAgIGlmIChlbnRyeS5pc0ludGVyc2VjdGluZykge1xuICAgICAgICAgICAgdGhpcy52aXNpYmxlRWxlbWVudHMuc2V0KGVudHJ5LnRhcmdldCwgZW50cnkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnZpc2libGVFbGVtZW50cy5kZWxldGUoZW50cnkudGFyZ2V0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcbiAgICAgICkuc3Vic2NyaWJlKCk7XG5cbiAgICAgIC8vIFN1YnNjcmliZSB0byBzbGlkZXIgc2Nyb2xsIGV2ZW50XG4gICAgICBmcm9tRXZlbnQodGhpcy5zbGlkZXIsICdzY3JvbGwnLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDUwKSxcbiAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLl9pc1Bhbm5pbmcpLFxuICAgICAgICB0YXAoKCkgPT4gdGhpcy5vblZpZXdwb3J0U2Nyb2xsKCkpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcbiAgICAgICkuc3Vic2NyaWJlKCk7XG5cbiAgICAgIC8vIERldGVjdCBpZiB0aGUgc2l6ZSBvZiB0aGUgc2xpZGVyIGhhcyBjaGFuZ2VkIGRldGVjdGluZyBjdXJyZW50IGluZGV4IG9uIHNjcm9sbFxuICAgICAgaWYgKHRoaXMuX3BsYXRmb3JtLmlzQnJvd3Nlcikge1xuICAgICAgICByZXNpemVPYnNlcnZhYmxlKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQpLnBpcGUoXG4gICAgICAgICAgZGVib3VuY2VUaW1lKHRoaXMuY29uZmlnLnJlc2l6ZURlYm91bmNlVGltZSksXG4gICAgICAgICAgdGFwKChbZW50cnldOiBSZXNpemVPYnNlcnZlckVudHJ5W10pID0+IHRoaXMub25Ib3N0UmVzaXplKGVudHJ5KSksXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpXG4gICAgICAgICkuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5pdGVtcy5ub3RpZnlPbkNoYW5nZXMoKTtcbiAgICB0aGlzLml0ZW1zLmNoYW5nZXMucGlwZShcbiAgICAgIHN0YXJ0V2l0aChudWxsKSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIC8vIERpc2Nvbm5lY3QgYWxsIGFuZCByZWNvbm5lY3QgbGF0ZXJcbiAgICAgICAgdGhpcy52aXNpYmxlRWxlbWVudHMuZm9yRWFjaCgoaXRlbTogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeSkgPT4ge1xuICAgICAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIudW5vYnNlcnZlKGl0ZW0udGFyZ2V0KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQ29ubmVjdCB3aXRoIHRoZSBuZXcgaXRlbXNcbiAgICAgICAgdGhpcy5pdGVtcy50b0FycmF5KCkubWFwKChpdGVtOiBHYWxsZXJ5SXRlbUNvbXBvbmVudCkgPT4ge1xuICAgICAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZShpdGVtLmVsZW1lbnQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pLFxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpXG4gICAgKS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb25maWcuaXRlbUF1dG9zaXplKSB7XG4gICAgICB0aGlzLnNsaWRlci5zdHlsZS5zZXRQcm9wZXJ0eSgnLS1zbGlkZXItY2VudHJhbGl6ZS1zdGFydC1zaXplJywgdGhpcy5hZGFwdGVyLmdldENlbnRyYWxpemVyU3RhcnRTaXplKCkgKyAncHgnKTtcbiAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNldFByb3BlcnR5KCctLXNsaWRlci1jZW50cmFsaXplLWVuZC1zaXplJywgdGhpcy5hZGFwdGVyLmdldENlbnRyYWxpemVyRW5kU2l6ZSgpICsgJ3B4Jyk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fZGVzdHJveWVkJC5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveWVkJC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuZGVhY3RpdmF0ZUdlc3R1cmVzKCk7XG4gIH1cblxuICB0cmFja0J5Rm4oaW5kZXg6IG51bWJlciwgaXRlbTogYW55KSB7XG4gICAgcmV0dXJuIGl0ZW0udHlwZTtcbiAgfVxuXG4gIHByaXZhdGUgb25Ib3N0UmVzaXplKGVudHJ5OiBSZXNpemVPYnNlcnZlckVudHJ5KTogdm9pZCB7XG4gICAgY29uc3Qgd2lkdGg6IG51bWJlciA9IE1hdGguY2VpbChlbnRyeS5jb250ZW50UmVjdC53aWR0aCk7XG4gICAgY29uc3QgaGVpZ2h0OiBudW1iZXIgPSBNYXRoLmNlaWwoZW50cnkuY29udGVudFJlY3QuaGVpZ2h0KTtcbiAgICB0aGlzLnNsaWRlci5zdHlsZS53aWR0aCA9IGAkeyB3aWR0aCB9cHhgO1xuICAgIHRoaXMuc2xpZGVyLnN0eWxlLmhlaWdodCA9IGAkeyBoZWlnaHQgfXB4YDtcbiAgICB0aGlzLnNjcm9sbFRvSW5kZXgodGhpcy5zdGF0ZS5jdXJySW5kZXgsICdhdXRvJyk7XG4gICAgLy8gRGV0ZWN0IGNoYW5nZXMgb24gZ2FsbGVyeS1pdGVtIGNvbXBvbmVudHMgdG8gcmUtY2FsY3VsYXRlIGl0ZW0gc2l6ZVxuICAgIHRoaXMuX2NkLmRldGVjdENoYW5nZXMoKTtcbiAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn8J+mkCBbR2FsbGVyeSBPbkhvc3RSZXNpemVdOiBzZXQgdmlld3BvcnQgd2lkdGggdG8gYWJzb2x1dGUgbnVtYmVyJyk7XG4gIH1cblxuICBwcml2YXRlIG9uVmlld3BvcnRTY3JvbGwoKTogdm9pZCB7XG4gICAgLy8gQ2hlY2sgaWYgc2Nyb2xsZWQgaXRlbSBpcyBncmVhdCBlbm91Z2ggdG8gbmF2aWdhdGVcbiAgICBjb25zdCBjdXJyRWxlbWVudDogRWxlbWVudCA9IHRoaXMuaXRlbXMuZ2V0KHRoaXMuc3RhdGUuY3VyckluZGV4KT8uZWxlbWVudDtcbiAgICBjb25zdCBlbGVtZW50QXRDZW50ZXI6IEVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnRGcm9tVmlld3BvcnRDZW50ZXIoKTtcblxuICAgIGlmIChlbGVtZW50QXRDZW50ZXIpIHtcbiAgICAgIC8vIENoZWNrIGlmIHRoZSBnYWxsZXJ5LWl0ZW0gZWxlbWVudCBpcyBub3QgdGhlIGFjdGl2ZSBlbGVtZW50XG4gICAgICBpZiAoZWxlbWVudEF0Q2VudGVyICE9PSBjdXJyRWxlbWVudCkge1xuICAgICAgICB0aGlzLnRyeVNjcm9sbFRvRWxlbWVudChlbGVtZW50QXRDZW50ZXIgYXMgSFRNTEVsZW1lbnQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn4oGJIFtHYWxsZXJ5IG9uVmlld3BvcnRTY3JvbGxdOiBObyBjZW50ZXIgZWxlbWVudCB3YXMgZm91bmQnKTtcbiAgICAgIHRoaXMudmlzaWJsZUVsZW1lbnRzLmZvckVhY2goKGVudHJ5OiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5KSA9PiB7XG4gICAgICAgIHRoaXMudHJ5U2Nyb2xsVG9FbGVtZW50KGVudHJ5LnRhcmdldCBhcyBIVE1MRWxlbWVudCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyeVNjcm9sbFRvRWxlbWVudChlbGVtZW50QXRDZW50ZXI6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgYWxsb3dlZE1hcmdpbjogbnVtYmVyID0gMTA7XG4gICAgY29uc3Qgb2Zmc2V0RGlmZjogbnVtYmVyID0gKHRoaXMuYWRhcHRlci5jbGllbnRTaXplIC0gdGhpcy5hZGFwdGVyLmdldENsaWVudFNpemUoZWxlbWVudEF0Q2VudGVyKSkgLyAyO1xuICAgIGNvbnN0IHJhbmdlU3RhcnQ6IG51bWJlciA9IHRoaXMuYWRhcHRlci5zY3JvbGxWYWx1ZSArIG9mZnNldERpZmY7XG4gICAgY29uc3QgcmFuZ2VFbmQ6IG51bWJlciA9IHRoaXMuYWRhcHRlci5zY3JvbGxWYWx1ZSArIHRoaXMuYWRhcHRlci5jbGllbnRTaXplIC0gb2Zmc2V0RGlmZjtcbiAgICBjb25zdCBlbFN0YXJ0OiBudW1iZXIgPSB0aGlzLmFkYXB0ZXIuZ2V0T2Zmc2V0U2l6ZShlbGVtZW50QXRDZW50ZXIpO1xuICAgIGNvbnN0IGVsRW5kOiBudW1iZXIgPSBlbFN0YXJ0ICsgdGhpcy5hZGFwdGVyLmdldENsaWVudFNpemUoZWxlbWVudEF0Q2VudGVyKTtcblxuICAgIGNvbnN0IGlzU3RhcnQ6IGJvb2xlYW4gPSByYW5nZVN0YXJ0ICsgYWxsb3dlZE1hcmdpbiA+PSBlbFN0YXJ0ICYmIHJhbmdlU3RhcnQgLSBhbGxvd2VkTWFyZ2luIDw9IGVsU3RhcnQ7XG4gICAgY29uc3QgaXNFbmQ6IGJvb2xlYW4gPSByYW5nZUVuZCArIGFsbG93ZWRNYXJnaW4gPj0gZWxFbmQgJiYgcmFuZ2VFbmQgLSBhbGxvd2VkTWFyZ2luIDw9IGVsRW5kO1xuXG4gICAgLy8gUmVzZXQgcG9zaXRpb25cbiAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9IHRoaXMuYWRhcHRlci5zY3JvbGxTbmFwVHlwZTtcblxuICAgIC8vIENoZWNrIGlmIGVsZW1lbnQgaXMgd2l0aGluIHRoZSBkZXRlY3Rpb24gcmFuZ2VcbiAgICBpZiAoaXNTdGFydCAmJiBpc0VuZCkge1xuICAgICAgLy8gSWYgZWxlbWVudCBpcyB3aXRoaW4gdGhlIHJhbmdlIHNldCBpdCBhcyB0aGUgYWN0aXZlIGdhbGxlcnkgaXRlbVxuICAgICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoJ/CfjYQgW0dhbGxlcnkgb25WaWV3cG9ydFNjcm9sbF06IFNldCBhY3RpdmUgZ2FsbGVyeSBpdGVtJyk7XG5cbiAgICAgIGNvbnN0IGluZGV4OiBudW1iZXIgPSArZWxlbWVudEF0Q2VudGVyLmdldEF0dHJpYnV0ZSgnZ2FsbGVyeUluZGV4Jyk7XG4gICAgICB0aGlzLl96b25lLnJ1bigoKSA9PiB0aGlzLl9nYWxsZXJ5LnJlZih0aGlzLmdhbGxlcnlJZCkuc2V0KGluZGV4LCAnc21vb3RoJykpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2Nyb2xsVG9JbmRleCh2YWx1ZTogbnVtYmVyLCBiZWhhdmlvcjogU2Nyb2xsQmVoYXZpb3IsIG9uRW5kPzogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMuc2Nyb2xsSGFuZGxlciQubmV4dCh7IHZhbHVlLCBiZWhhdmlvciwgb25FbmQgfSk7XG4gIH1cblxuICBwcml2YXRlIGVuYWJsZURpc2FibGVHZXN0dXJlcygpOiB2b2lkIHtcbiAgICAvLyBFbmFibGUvRGlzYWJsZSBtb3VzZSBzbGlkaW5nIG9uIGRlc2t0b3AgYnJvd3NlciBvbmx5XG4gICAgaWYgKCF0aGlzLl9wbGF0Zm9ybS5JT1MgJiYgIXRoaXMuX3BsYXRmb3JtLkFORFJPSUQpIHtcbiAgICAgIGlmICghdGhpcy5jb25maWcubW91c2VTbGlkaW5nRGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZUdlc3R1cmVzKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRlYWN0aXZhdGVHZXN0dXJlcygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWN0aXZhdGVHZXN0dXJlcygpOiB2b2lkIHtcbiAgICBpZiAodHlwZW9mIEhhbW1lciAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIC8vIERlc3Ryb3kgaGFtbWVyIGlmIGEgcHJldmlvdXMgaW5zdGFuY2Ugd2FzIGNyZWF0ZWRcbiAgICAgIHRoaXMuZGVhY3RpdmF0ZUdlc3R1cmVzKCk7XG5cbiAgICAgIGNvbnN0IGRpcmVjdGlvbjogbnVtYmVyID0gdGhpcy5hZGFwdGVyLnBhbkRpcmVjdGlvbjtcblxuICAgICAgLy8gQWN0aXZhdGUgZ2VzdHVyZXNcbiAgICAgIHRoaXMuX3pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICB0aGlzLl9oYW1tZXIgPSBuZXcgSGFtbWVyKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIHsgaW5wdXRDbGFzczogSGFtbWVyLk1vdXNlSW5wdXQgfSk7XG4gICAgICAgIHRoaXMuX2hhbW1lci5nZXQoJ3BhbicpLnNldCh7IGRpcmVjdGlvbiB9KTtcblxuICAgICAgICBsZXQgcGFuT2Zmc2V0OiBudW1iZXI7XG5cbiAgICAgICAgLy8gU2V0IHBhbk9mZnNldCBmb3Igc2xpZGluZyBvbiBwYW4gc3RhcnQgZXZlbnRcbiAgICAgICAgdGhpcy5faGFtbWVyLm9uKCdwYW5zdGFydCcsICgpID0+IHtcbiAgICAgICAgICB0aGlzLl9zbW9vdGhTY3JvbGwuZGlzbWlzc09uZ29pbmdTY3JvbGwodGhpcy5zbGlkZXIpO1xuICAgICAgICAgIHBhbk9mZnNldCA9IHRoaXMuYWRhcHRlci5zY3JvbGxWYWx1ZTtcbiAgICAgICAgICAvLyBEaXNhYmxlIHNjcm9sbC1zbmFwLXR5cGUgZnVuY3Rpb25hbGl0eVxuICAgICAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNjcm9sbFNuYXBUeXBlID0gJ3Vuc2V0JztcbiAgICAgICAgICB0aGlzLnNsaWRlci5jbGFzc0xpc3QuYWRkKCdnLXNsaWRpbmcnKTtcbiAgICAgICAgICB0aGlzLl9pc1Bhbm5pbmcgPSB0cnVlO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9oYW1tZXIub24oJ3Bhbm1vdmUnLCAoZTogYW55KSA9PiB0aGlzLnNsaWRlci5zY3JvbGxUbyh0aGlzLmFkYXB0ZXIuZ2V0UGFuVmFsdWUocGFuT2Zmc2V0LCBlLCAnYXV0bycpKSk7XG5cbiAgICAgICAgdGhpcy5faGFtbWVyLm9uKCdwYW5lbmQnLCAoZTogYW55KSA9PiB0aGlzLm9uUGFuRW5kKGUpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVhY3RpdmF0ZUdlc3R1cmVzKCk6IHZvaWQge1xuICAgIHRoaXMuX2hhbW1lcj8uZGVzdHJveSgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIG9uUGFuRW5kKGUpOiB2b2lkIHtcblxuICAgIHRoaXMuX2dhbGxlcnkuZGVidWdDb25zb2xlKCfwn5ax77iPIFtHYWxsZXJ5XTogb25QYW5FbmQnLCBlKTtcblxuICAgIHRoaXMuc2xpZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2ctc2xpZGluZycpO1xuICAgIGNvbnN0IGRlbHRhOiBudW1iZXIgPSB0aGlzLmFkYXB0ZXIuZ2V0UGFuRGVsdGEoZSk7XG4gICAgY29uc3QgdmVsb2NpdHk6IG51bWJlciA9IHRoaXMuYWRhcHRlci5nZXRQYW5WZWxvY2l0eShlKTtcblxuICAgIGNvbnN0IGdhbGxlcnlSZWYgPSB0aGlzLl9nYWxsZXJ5LnJlZih0aGlzLmdhbGxlcnlJZCk7XG5cbiAgICB0aGlzLl96b25lLnJ1bigoKSA9PiB7XG4gICAgICAvLyBDaGVjayBpZiBzY3JvbGxlZCBpdGVtIGlzIGdyZWF0IGVub3VnaCB0byBuYXZpZ2F0ZVxuICAgICAgY29uc3QgY3VyckVsZW1lbnQ6IEVsZW1lbnQgPSB0aGlzLml0ZW1zLmdldCh0aGlzLnN0YXRlLmN1cnJJbmRleCk/LmVsZW1lbnQ7XG5cbiAgICAgIC8vIEZpbmQgdGhlIGdhbGxlcnkgaXRlbSBlbGVtZW50IGluIHRoZSBjZW50ZXIgZWxlbWVudHNcbiAgICAgIGNvbnN0IGVsZW1lbnRBdENlbnRlcjogRWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudEZyb21WaWV3cG9ydENlbnRlcigpO1xuXG4gICAgICAvLyBDaGVjayBpZiBjZW50ZXIgaXRlbSBjYW4gYmUgdGFrZW4gZnJvbSBlbGVtZW50IHVzaW5nXG4gICAgICBpZiAoZWxlbWVudEF0Q2VudGVyICYmIGVsZW1lbnRBdENlbnRlciAhPT0gY3VyckVsZW1lbnQpIHtcbiAgICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9ICtlbGVtZW50QXRDZW50ZXIuZ2V0QXR0cmlidXRlKCdnYWxsZXJ5SW5kZXgnKTtcbiAgICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KGluZGV4LCAnc21vb3RoJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgZGVsdGEgaXMgZ3JlYXQgZW5vdWdoIHRvIG5hdmlnYXRlXG4gICAgICBpZiAoTWF0aC5hYnMoZGVsdGEpID4gKGN1cnJFbGVtZW50LmNsaWVudFdpZHRoIHx8IHRoaXMuYWRhcHRlci5jbGllbnRTaXplKSAvIDIpIHtcbiAgICAgICAgcmV0dXJuIGRlbHRhID4gMCA/IGdhbGxlcnlSZWYucHJldignc21vb3RoJywgZmFsc2UpIDogZ2FsbGVyeVJlZi5uZXh0KCdzbW9vdGgnLCBmYWxzZSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIHZlbG9jaXR5IGlzIGdyZWF0IGVub3VnaCB0byBuYXZpZ2F0ZVxuICAgICAgaWYgKE1hdGguYWJzKHZlbG9jaXR5KSA+IDAuMykge1xuICAgICAgICByZXR1cm4gdmVsb2NpdHkgPiAwID8gZ2FsbGVyeVJlZi5wcmV2KCdzbW9vdGgnLCBmYWxzZSkgOiBnYWxsZXJ5UmVmLm5leHQoJ3Ntb290aCcsIGZhbHNlKTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVzZXQgcG9zaXRpb24gdG8gdGhlIGN1cnJlbnQgaW5kZXhcbiAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLnN0YXRlLmN1cnJJbmRleCwgJ3Ntb290aCcpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRFbGVtZW50RnJvbVZpZXdwb3J0Q2VudGVyKCk6IEVsZW1lbnQge1xuICAgIC8vIEdldCBzbGlkZXIgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGRvY3VtZW50XG4gICAgY29uc3Qgc2xpZGVyUmVjdCA9IHRoaXMuc2xpZGVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIC8vIFRyeSBsb29rIGZvciB0aGUgY2VudGVyIGl0ZW0gdXNpbmcgYGVsZW1lbnRzRnJvbVBvaW50YCBmdW5jdGlvblxuICAgIGNvbnN0IGNlbnRlckVsZW1lbnRzID0gZG9jdW1lbnQuZWxlbWVudHNGcm9tUG9pbnQoc2xpZGVyUmVjdC54ICsgKHNsaWRlclJlY3Qud2lkdGggLyAyKSwgc2xpZGVyUmVjdC55ICsgKHNsaWRlclJlY3QuaGVpZ2h0IC8gMikpO1xuICAgIC8vIEZpbmQgdGhlIGdhbGxlcnkgaXRlbSBlbGVtZW50IGluIHRoZSBjZW50ZXIgZWxlbWVudHNcbiAgICBjb25zdCBlbGVtZW50ID0gY2VudGVyRWxlbWVudHMuZmluZCgoZWxlbWVudDogRWxlbWVudCkgPT4gZWxlbWVudC5sb2NhbE5hbWUgPT09ICdnYWxsZXJ5LWl0ZW0nICYmIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdnYWxsZXJ5SWQnKSA9PT0gdGhpcy5nYWxsZXJ5SWQpO1xuXG4gICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoJ/Cfqp8gW0dhbGxlcnldOiBnZXRFbGVtZW50RnJvbVZpZXdwb3J0Q2VudGVyJywgZWxlbWVudCk7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUludGVyc2VjdGlvbk9ic2VydmVyKHNsaWRlcjogSFRNTEVsZW1lbnQpOiBPYnNlcnZhYmxlPEludGVyc2VjdGlvbk9ic2VydmVyRW50cnk+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBTdWJzY3JpYmVyPEludGVyc2VjdGlvbk9ic2VydmVyRW50cnlbXT4pID0+IHtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoXG4gICAgICAgIChlbnRyaWVzOiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5W10pID0+IG9ic2VydmVyLm5leHQoZW50cmllcyksXG4gICAgICAgIHsgcm9vdDogc2xpZGVyIH1cbiAgICAgICk7XG4gICAgICByZXR1cm4gKCkgPT4gdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgfSkucGlwZShcbiAgICAgIG1lcmdlTWFwKChlbnRyaWVzOiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5W10pID0+IGVudHJpZXMpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICApO1xuICB9XG59XG4iXX0=